+function(exports){var middleware=[];function page(path,fn){if("function"==typeof fn){var route=new Route(path);for(var i=1;i<arguments.length;++i)middleware.push(route.middleware(arguments[i]))}else path?page.show(path,fn):page.start()}page.start=function(){addEventListener("click",onclick,!0),addEventListener("popstate",onpopstate,!1)},page.root="",page.show=function(path,state,ctx){state=state||{},state._path=path,history.pushState(state,document.title,path),page.dispatch(ctx)},page.replace=function(path,state,ctx){state=state||{},state._path=path,history.replaceState(state,document.title,path),page.dispatch(ctx)},page.dispatch=function(ctx){var i=0;ctx=ctx||{};function next(){var fn=middleware[i++];if(!fn)return;fn(ctx,next)}next()},page.path=function(query){var path=location.pathname;return 0==path.indexOf(page.root)&&(path=path.replace(page.root,"")),path+(query?location.search||"":"")};function Route(path,options){options=options||{},this.path=path,this.method="GET",this.regexp=pathtoRegexp(path,this.keys=[],options.sensitive,options.strict)}Route.prototype.middleware=function(fn){var self=this;return function(ctx,next){ctx.params=ctx.params||[],ctx.path=page.path();if(self.match(ctx.path,ctx.params))return fn(ctx,next);next()}},Route.prototype.match=function(path,params){var keys=this.keys,m=this.regexp.exec(path);if(!m)return!1;for(var i=1,len=m.length;i<len;++i){var key=keys[i-1],val="string"==typeof m[i]?decodeURIComponent(m[i]):m[i];key?params[key.name]=undefined!==params[key.name]?params[key.name]:val:params.push(val)}return!0};function pathtoRegexp(path,keys,sensitive,strict){return path instanceof RegExp?path:(path instanceof Array&&(path="("+path.join("|")+")"),path=path.concat(strict?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(_,slash,format,key,capture,optional){return keys.push({name:key,optional:!!optional}),slash=slash||"",""+(optional?"":slash)+"(?:"+(optional?slash:"")+(format||"")+(capture||format&&"([^/.]+?)"||"([^/]+?)")+")"+(optional||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),new RegExp("^"+path+"$",sensitive?"":"i"))}function onpopstate(e){e.state?page.replace(e.state._path,null,e):page.show(page.path(!0),null,e)}function onclick(e){if("A"!=e.target.nodeName)return;e.preventDefault();var href=e.target.getAttribute("href");page.show(href,null,e)}exports.page=page}(this);